"use strict";(()=>{function y(n,e={}){let{signal:t}=e;return t?.aborted?Promise.reject(new DOMException("Delay was aborted.","AbortError")):new Promise((r,s)=>{let o=()=>{clearTimeout(a),s(new DOMException("Delay was aborted.","AbortError"))},a=setTimeout(()=>{t?.removeEventListener("abort",o),r()},n);t?.addEventListener("abort",o,{once:!0})})}var u="Server closed",m=5,E=1e3,f=class{#n;#s;#i;#e=!1;#t=new Set;#r=new Set;#a;constructor(e){this.#n=e.port,this.#s=e.hostname,this.#i=e.handler,this.#a=e.onError??function(t){return console.error(t),new Response("Internal Server Error",{status:500})}}async serve(e){if(this.#e)throw new Deno.errors.Http(u);this.#h(e);try{return await this.#d(e)}finally{this.#u(e);try{e.close()}catch{}}}async listenAndServe(){if(this.#e)throw new Deno.errors.Http(u);let e=Deno.listen({port:this.#n??80,hostname:this.#s??"0.0.0.0",transport:"tcp"});return await this.serve(e)}async listenAndServeTls(e,t){if(this.#e)throw new Deno.errors.Http(u);let r=Deno.listenTls({port:this.#n??443,hostname:this.#s??"0.0.0.0",certFile:e,keyFile:t,transport:"tcp"});return await this.serve(r)}close(){if(this.#e)throw new Deno.errors.Http(u);this.#e=!0;for(let e of this.#t)try{e.close()}catch{}this.#t.clear();for(let e of this.#r)this.#o(e);this.#r.clear()}get closed(){return this.#e}get addrs(){return Array.from(this.#t).map(e=>e.addr)}async#c(e,t,r){let s;try{s=await this.#i(e.request,r)}catch(o){s=await this.#a(o)}try{await e.respondWith(s)}catch{return this.#o(t)}}async#l(e,t){for(;!this.#e;){let r;try{r=await e.nextRequest()}catch{break}if(r===null)break;this.#c(r,e,t)}this.#o(e)}async#d(e){let t;for(;!this.#e;){let r;try{r=await e.accept()}catch(i){if(i instanceof Deno.errors.BadResource||i instanceof Deno.errors.InvalidData||i instanceof Deno.errors.UnexpectedEof||i instanceof Deno.errors.ConnectionReset||i instanceof Deno.errors.NotConnected){t?t*=2:t=m,t>=1e3&&(t=E),await y(t);continue}throw i}t=void 0;let s;try{s=Deno.serveHttp(r)}catch{continue}this.#f(s);let o={localAddr:r.localAddr,remoteAddr:r.remoteAddr};this.#l(s,o)}}#o(e){this.#p(e);try{e.close()}catch{}}#h(e){this.#t.add(e)}#u(e){this.#t.delete(e)}#f(e){this.#r.add(e)}#p(e){this.#r.delete(e)}};function g(n){return n==="0.0.0.0"?"localhost":n}async function w(n,e={}){let t=e.port??8e3,r=e.hostname??"0.0.0.0",s=new f({port:t,hostname:r,handler:n,onError:e.onError});e?.signal?.addEventListener("abort",()=>s.close(),{once:!0});let o=s.listenAndServe();return t=s.addrs[0].port,"onListen"in e?e.onListen?.({port:t,hostname:r}):console.log(`Listening on http://${g(r)}:${t}/`),await o}var p={},D=new TextDecoder;p.show=async function(n){let e=await Deno.run({stdout:"piped",cmd:["wg","show",n]}).output(),t=D.decode(e).split(`

`),r=[],s;return t.forEach(function(o){let i=o.slice(0,o.indexOf(": ")),a={};i=="peer"?(a.type="peer",o.split(`
`).forEach(function(c){let l=c.indexOf(": "),d=c.slice(0,l),h=c.slice(l+2);d=="peer"?a.pub=h:d=="  endpoint"?a.end=h:d=="  allowed ips"&&(a.range=h.replaceAll(" ",""))})):i=="interface"&&(a.type="self",o.split(`
`).forEach(function(c){let l=c.indexOf(": "),d=c.slice(0,l),h=c.slice(l+2);d=="  public key"&&(a.pub=h)}),s=a),i?.length>2&&r.push(a)}),{ifname:n,peers:r,self:s}};p.setPeer=function(n,e,t=30){let r=["wg","set",n,"peer",e.pub,"persistent-keepalive",t.toString()];e.end&&(r.push("endpoint"),r.push(e.end)),e.range&&(r.push("allowed-ips"),r.push(e.range)),Deno.run({cmd:r})};p.delPeer=function(n,e){Deno.run({cmd:["wg","set",n,"peer",e]})};var v=async function(n,e){return new Response(e)};w(async function(n,e){let t=e.remoteAddr.hostname;return await v(n,t)});})();
