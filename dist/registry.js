"use strict";(()=>{function A(r,e={}){let{signal:t}=e;return t?.aborted?Promise.reject(new DOMException("Delay was aborted.","AbortError")):new Promise((n,s)=>{let o=()=>{clearTimeout(a),s(new DOMException("Delay was aborted.","AbortError"))},a=setTimeout(()=>{t?.removeEventListener("abort",o),n()},r);t?.addEventListener("abort",o,{once:!0})})}var f="Server closed",b=5,D=1e3,p=class{#n;#s;#i;#e=!1;#t=new Set;#r=new Set;#a;constructor(e){this.#n=e.port,this.#s=e.hostname,this.#i=e.handler,this.#a=e.onError??function(t){return console.error(t),new Response("Internal Server Error",{status:500})}}async serve(e){if(this.#e)throw new Deno.errors.Http(f);this.#u(e);try{return await this.#h(e)}finally{this.#d(e);try{e.close()}catch{}}}async listenAndServe(){if(this.#e)throw new Deno.errors.Http(f);let e=Deno.listen({port:this.#n??80,hostname:this.#s??"0.0.0.0",transport:"tcp"});return await this.serve(e)}async listenAndServeTls(e,t){if(this.#e)throw new Deno.errors.Http(f);let n=Deno.listenTls({port:this.#n??443,hostname:this.#s??"0.0.0.0",certFile:e,keyFile:t,transport:"tcp"});return await this.serve(n)}close(){if(this.#e)throw new Deno.errors.Http(f);this.#e=!0;for(let e of this.#t)try{e.close()}catch{}this.#t.clear();for(let e of this.#r)this.#o(e);this.#r.clear()}get closed(){return this.#e}get addrs(){return Array.from(this.#t).map(e=>e.addr)}async#l(e,t,n){let s;try{s=await this.#i(e.request,n)}catch(o){s=await this.#a(o)}try{await e.respondWith(s)}catch{return this.#o(t)}}async#c(e,t){for(;!this.#e;){let n;try{n=await e.nextRequest()}catch{break}if(n===null)break;this.#l(n,e,t)}this.#o(e)}async#h(e){let t;for(;!this.#e;){let n;try{n=await e.accept()}catch(i){if(i instanceof Deno.errors.BadResource||i instanceof Deno.errors.InvalidData||i instanceof Deno.errors.UnexpectedEof||i instanceof Deno.errors.ConnectionReset||i instanceof Deno.errors.NotConnected){t?t*=2:t=b,t>=1e3&&(t=D),await A(t);continue}throw i}t=void 0;let s;try{s=Deno.serveHttp(n)}catch{continue}this.#f(s);let o={localAddr:n.localAddr,remoteAddr:n.remoteAddr};this.#c(s,o)}}#o(e){this.#p(e);try{e.close()}catch{}}#u(e){this.#t.add(e)}#d(e){this.#t.delete(e)}#f(e){this.#r.add(e)}#p(e){this.#r.delete(e)}};function L(r){return r==="0.0.0.0"?"localhost":r}async function w(r,e={}){let t=e.port??8e3,n=e.hostname??"0.0.0.0",s=new p({port:t,hostname:n,handler:r,onError:e.onError});e?.signal?.addEventListener("abort",()=>s.close(),{once:!0});let o=s.listenAndServe();return t=s.addrs[0].port,"onListen"in e?e.onListen?.({port:t,hostname:n}):console.log(`Listening on http://${L(n)}:${t}/`),await o}var d={},S=new TextDecoder;d.show=async function(r){let e=await Deno.run({stdout:"piped",cmd:["wg","show",r]}).output(),t=S.decode(e).split(`

`),n=[],s;return t.forEach(function(o){let i=o.slice(0,o.indexOf(": ")),a={};i=="peer"?(a.type="peer",o.split(`
`).forEach(function(l){let c=l.indexOf(": "),h=l.slice(0,c),u=l.slice(c+2);h=="peer"?a.pub=u:h=="  endpoint"?a.end=u:h=="  allowed ips"&&(a.range=u.replaceAll(" ",""))})):i=="interface"&&(a.type="self",o.split(`
`).forEach(function(l){let c=l.indexOf(": "),h=l.slice(0,c),u=l.slice(c+2);h=="  public key"&&(a.pub=u)}),s=a),i?.length>2&&n.push(a)}),{ifname:r,peers:n,self:s}};d.setPeer=function(r,e,t=30){let n=["wg","set",r,"peer",e.pub,"persistent-keepalive",t.toString()];e.end&&(n.push("endpoint"),n.push(e.end)),e.range&&(n.push("allowed-ips"),n.push(e.range)),Deno.run({cmd:n})};d.delPeer=function(r,e){Deno.run({cmd:["wg","set",r,"peer",e]})};var m=function(r,e){let t=Math.min(r.length,e.length),n=r.slice(0,t),s=e.slice(0,t),o=0,i=0;for(;i<t&&o==0;)o=Math.sign(n[i]-s[i]),i++;return o},y=function(){this.pool=[],this.point=function(r,e=!1){if(this.pool.length>0){let t=this.pool.length,n=1<<Math.floor(Math.log2(t)),s=n,o=64;for(;n>=1&&o>=0;){if(o<=0)throw new Error("TTL reached.");if(s==t)s-=n;else{let a=m(r,this.pool[s]);switch(a){case 0:{o=0;break}case 1:{s+n<=t&&(s+=n);break}case-1:{s!=0&&(s-=n);break}default:console.warn(`Unexpected result ${a}.`)}}n=n>>1,o--}let i=!0;if(s>=this.pool.length)i=!1;else{let a=this;this.pool[s].forEach(function(l,c,h){i&&l!=r[c]&&(i=!1)}),!i&&m(r,this.pool[s])>0&&s++}return i||e?s:-1}else return e?0:-1},this.add=function(r,e){return r.data=e,this.pool.splice(this.point(r,!0),0,r),this},this.default=function(r){console.warn(`No match for "${r}". Default action not defined.`)},this.get=function(r){let e=this.point(r);if(e>-1)return this.pool[e].data;this.default(r)},this.run=function(r,...e){let t=this.point(r);t>-1?this.pool[t].data(r.slice(this.pool[t].length),...e):this.default(r,...e)}};var g=class extends y{reply(r,...e){let t=[],n="",s=new Response("API Not Found",{status:404});Array.from(r).forEach(function(i){t.push(i.charCodeAt(0))});let o=this.point(t);return o>-1?(t.slice(this.pool[o].length).forEach(function(i){n+=String.fromCharCode(i)}),this.pool[o].data(n,...e)||s):s}handle(r,e){let t=[];return Array.from(r).forEach(function(n){t.push(n.charCodeAt(0))}),this.add(t,e)}constructor(...r){super(...r)}};var v=new g;v.handle("/get/",async function(r,e,t){let n=r.split("/"),s=JSON.stringify(await d.show(n[0]));return s.length>2?new Response(s):new Response(`Unknown interface "${n[0]}".`,{status:400})});var E=async function(r,e){let t=new URL(r.url);return v.reply(`${t.pathname}${t.search}${t.hash}`,r,e)};w(async function(r,e){let t=e.remoteAddr.hostname;return await E(r,t)},{port:8362});})();
